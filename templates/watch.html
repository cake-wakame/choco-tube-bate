{% extends "base.html" %}

{% block title %}{{ video.title if video else 'å‹•ç”»' }} - ãƒãƒ§ã‚³Tube{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js" rel="preload" as="script">
{% endblock %}

{% block content %}
<div class="watch-container">
    <div class="watch-main">
        <div class="player-container">
            <div id="player-wrapper" class="player-wrapper">
                {% if mode == 'embed' %}
                <iframe id="embed-player" class="embed-player"
                        src="{{ streams.embed }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                {% elif mode == 'education' %}
                <iframe id="embed-player" class="embed-player"
                        src="{{ streams.education }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                {% elif mode == 'high' and video and video.highstreamUrl %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg">
                    <source src="{{ video.highstreamUrl }}" type="video/webm">
                </video>
                {% elif video and video.videoUrls %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg">
                    {% for url in video.videoUrls %}
                    <source src="{{ url }}" type="video/mp4">
                    {% endfor %}
                </video>
                {% elif streams.primary %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg">
                    <source src="{{ streams.primary }}" type="video/mp4">
                </video>
                {% elif streams.m3u8 %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg"></video>
                {% else %}
                <iframe id="embed-player" class="embed-player"
                        src="{{ streams.embed }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                {% endif %}
            </div>

            <div class="player-controls">
                <a href="/watch?v={{ video_id }}" class="player-source-btn {% if mode == 'stream' %}active{% endif %}">
                    <span>ğŸ¬ ã‚¹ãƒˆãƒªãƒ¼ãƒ </span>
                </a>
                <a href="/w?v={{ video_id }}" class="player-source-btn {% if mode == 'high' %}active{% endif %}">
                    <span>ğŸ“º é«˜ç”»è³ª</span>
                </a>
                <a href="/ume?v={{ video_id }}" class="player-source-btn {% if mode == 'embed' %}active{% endif %}">
                    <span>ğŸ”— åŸ‹ã‚è¾¼ã¿</span>
                </a>
                <a href="/edu?v={{ video_id }}" class="player-source-btn {% if mode == 'education' %}active{% endif %}">
                    <span>ğŸ“ Education</span>
                </a>
            </div>

            {% if video and video.streamUrls %}
            <div class="resolution-selector">
                <label for="resolutionSelect">ç”»è³ªé¸æŠ:</label>
                <select id="resolutionSelect">
                    {% for stream in video.streamUrls %}
                    <option value="{{ stream.url }}">{{ stream.resolution }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>

        {% if video %}
        <div class="video-details">
            <h1 class="video-title">{{ video.title }}</h1>
            <div class="video-stats">
                <span class="views">{{ video.views }} å›è¦–è´</span>
                <span class="separator">â€¢</span>
                <span class="published">{{ video.published }}</span>
                <span class="likes">ğŸ‘ {{ video.likes }}</span>
            </div>

            <div class="channel-info">
                {% if video.authorThumbnail %}
                <img src="{{ video.authorThumbnail }}" alt="{{ video.author }}" class="channel-avatar">
                {% endif %}
                <div class="channel-details">
                    <a href="/channel/{{ video.authorId }}" class="channel-name">{{ video.author }}</a>
                    {% if video.subscribers %}
                    <span class="subscribers">{{ video.subscribers }} äºº</span>
                    {% endif %}
                </div>
            </div>

            <div class="description">
                <div class="description-content" id="description">
                    {{ video.description|safe }}
                </div>
                <button class="description-toggle" id="desc-toggle">ã‚‚ã£ã¨è¦‹ã‚‹</button>
            </div>

            <div class="player-options">
                <label class="option-label">
                    <input type="checkbox" id="loopToggle">
                    ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
                </label>
                <label class="option-label">
                    <input type="checkbox" id="autoNextToggle">
                    è‡ªå‹•ã§æ¬¡ã®å‹•ç”»ã¸
                </label>
            </div>

            {% if video.videoUrls and video.videoUrls[0] %}
            <div class="download-section">
                <a href="{{ video.videoUrls[0] }}" download="{{ video.title }}" class="download-btn">
                    â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
            {% endif %}
        </div>

        <div class="comments-section">
            <h3 class="comments-title">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
            <div class="comments-list" id="comments">
                {% for comment in comments %}
                <div class="comment">
                    <img src="{{ comment.authorThumbnail }}" alt="{{ comment.author }}" class="comment-avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="/channel/{{ comment.authorId }}" class="comment-author">{{ comment.author }}</a>
                            <span class="comment-date">{{ comment.published }}</span>
                        </div>
                        <div class="comment-text">{{ comment.content|safe }}</div>
                        <div class="comment-actions">
                            <span class="comment-likes">ğŸ‘ {{ comment.likes }}</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="no-comments">ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <aside class="watch-sidebar">
        <h3 class="sidebar-title">é–¢é€£å‹•ç”»</h3>
        <div class="related-videos">
            {% if video and video.related %}
            {% for related in video.related %}
            <a href="/watch?v={{ related.id }}" class="related-card">
                <div class="related-thumbnail-container">
                    <img src="/thumbnail?v={{ related.id }}" alt="{{ related.title }}" class="related-thumbnail" loading="lazy">
                    {% if related.length %}
                    <span class="video-duration">{{ related.length }}</span>
                    {% endif %}
                </div>
                <div class="related-info">
                    <h4 class="related-title">{{ related.title }}</h4>
                    <a href="/channel/{{ related.authorId }}" class="related-author">{{ related.author }}</a>
                    <p class="related-views">{{ related.views }}</p>
                </div>
            </a>
            {% endfor %}
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const videoId = '{{ video_id }}';
    const m3u8Url = '{{ streams.m3u8|default("", true) }}';

    const video = document.getElementById('video-player');

    if (video && m3u8Url && !video.querySelector('source')) {
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(m3u8Url);
            hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = m3u8Url;
        }
    }

    const descToggle = document.getElementById('desc-toggle');
    const description = document.getElementById('description');
    if (descToggle && description) {
        descToggle.addEventListener('click', function() {
            description.classList.toggle('expanded');
            this.textContent = description.classList.contains('expanded') ? 'é–‰ã˜ã‚‹' : 'ã‚‚ã£ã¨è¦‹ã‚‹';
        });
    }

    const loopToggle = document.getElementById('loopToggle');
    const autoNextToggle = document.getElementById('autoNextToggle');

    function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? decodeURIComponent(v.pop()) : null;
    }

    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days || 30) * 24 * 60 * 60 * 1000);
        document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/';
    }

    if (loopToggle && video) {
        loopToggle.checked = getCookie('loop') === 'true';
        video.loop = loopToggle.checked;

        loopToggle.addEventListener('change', function() {
            video.loop = this.checked;
            setCookie('loop', this.checked, 30);
        });
    }

    if (autoNextToggle) {
        autoNextToggle.checked = getCookie('autonext') === 'true';

        autoNextToggle.addEventListener('change', function() {
            setCookie('autonext', this.checked, 30);
        });
    }

    if (video) {
        video.addEventListener('ended', function() {
            if (getCookie('autonext') === 'true') {
                {% if video and video.related and video.related|length > 0 %}
                setTimeout(function() {
                    window.location.href = '/watch?v={{ video.related[0].id }}';
                }, 3000);
                {% endif %}
            }
        });
    }

    const resolutionSelect = document.getElementById('resolutionSelect');
    if (resolutionSelect && video) {
        resolutionSelect.addEventListener('change', function() {
            const currentTime = video.currentTime;
            const isPaused = video.paused;

            video.src = this.value;
            video.currentTime = currentTime;
            if (!isPaused) {
                video.play();
            }
        });
    }

    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        if (video && (e.keyCode === 32 || e.keyCode === 75)) {
            e.preventDefault();
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }
    });
});
</script>
{% endblock %}
